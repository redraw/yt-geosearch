<!DOCTYPE html>
<html ng-app="YoutubeGeoSearch">
<head>
  <title>Geo-Search Youtube</title>
  <link rel="stylesheet" type="text/css" href="https://bootswatch.com/paper/bootstrap.min.css">

  <!-- angular -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
  <!-- ng-map -->
  <script src="https://rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.min.js"></script>
  <!-- maps api -->
  <script src="http://maps.google.com/maps/api/js?libraries=places"></script>
  <!-- moment.js -->
  <script src="http://momentjs.com/downloads/moment.min.js"></script>

  <style type="text/css">
  html, body { margin: 0; }
  #map { height: 100vh; }
  .full { width: 100%; height: 100%; padding:0; margin:0; }
  .panel-left { padding: 20px; height: 100vh; overflow-y: auto;}
  .no-padding { padding: 0px; }
  .video-item { padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid lightgray; }
  </style>
</head>

<body>
  <div class="row full" ng-controller="SearchCtrl">
    <div class="col-md-4 panel-left">

      <form>
        <div class="form-group">
          <input class="form-control" places-auto-complete size="80" ng-model="location" placeholder="Enter a place" 
            on-place-changed="placeChanged()" />
        </div>
        <div class="form-group">
          <div class="row">
            <div class="col-md-3">
              <div class="input-group">
                <input class="form-control" type="number" size="10" ng-model="params.radius">
                <div class="input-group-addon">km</div>
              </div>
            </div>
            <div class="col-md-6">
              <input class="form-control" type="text" ng-model="params.q" placeholder="query (optional)"></input>
            </div>
            <div class="col-md-3 text-right">
              <button class="btn btn-primary" type="submit" ng-click="search()">Search</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-inline">
            <input type="checkbox" ng-model="debug">debug
          </label> 
        </div>
      </form>

      <div ng-show="debug">
        <pre>{{ raw_results | json }}</pre>
      </div>

      <div class="video-items">
        <div ng-repeat="v in videos">
          <div class="media video-item" ng-mouseenter="bounceMarker(v.id)" ng-mouseleave="unbounceMarker(v.id)">
            <div class="media-left">
              <a href="{{ v.id | ytVideoLink }}">
                <img class="media-object" ng-src="{{ v.snippet.thumbnails.default.url }}"
                  width="{{ v.snippet.thumbnails.default.width }}"
                  height="{{ v.snippet.thumbnails.default.height }}"
                  alt="{{ v.snippet.title }}">
              </a>
            </div>
            <div class="media-body">
              <h5 class="media-heading">{{ v.snippet.title }}</h5>
              <p>
                by <a href="{{ v.snippet.channelId | ytChannelLink }}">{{ v.snippet.channelTitle }}</a><br>
                {{ v.snippet.publishedAt | fromNow }}
              </p>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 text-center">
            <br><a class="btn btn-default" ng-show="videos.length" ng-click="search()">Load more</a><br>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8 no-padding">
      <ng-map id="map" center="current-location" zoom="8" geo-fallback-center="la plata, argentina">
        <marker ng-repeat="marker in markers" id="{{ marker.id }}" on-click="logMarker()"
          position="{{ marker.position }}" title="{{ marker.title }}">
        </marker>
      </div>
    </div>
  </div>
  
  <script type="text/javascript">
  var app = angular.module('YoutubeGeoSearch', ['ngMap']);

  app.filter('fromNow', function() {
    return function(date) {
      return moment(date).fromNow();
    }
  })

  app.filter('ytVideoLink', function() {
    return function(id) {
      return "https://www.youtube.com/watch?v=" + id
    }
  })

  app.filter('ytChannelLink', function() {
    return function(id) {
      return "https://www.youtube.com/channel/" + id
    }
  })

  app.controller('SearchCtrl', function($scope, $http, NgMap) {
    $scope.debug = false;
    $scope.params = {};
    $scope.params.radius = 10;
    $scope.params.limit = 10;
    $scope.videos = [];
    $scope.markers = [];

    $scope.bounds = new google.maps.LatLngBounds();

    NgMap.getMap().then(function(map) {
      $scope.map = map;
    });

    $scope.placeChanged = function() {
      $scope.reset();
      $scope.place = this.getPlace();
      $scope.params.lat = $scope.place.geometry.location.lat();
      $scope.params.lng = $scope.place.geometry.location.lng()
      $scope.search();
    }

    $scope.search = function() {
      var config = {
        params: $scope.params
      }

      $http.get('/search', config).then(function(response) {
        $scope.raw_results = response.data;
        $scope.params.next = response.data.next;

        // center map
        $scope.map.setCenter($scope.place.geometry.location);

        // add videos
        $scope.addVideos(response.data.videos);
      })
    }

    $scope.addVideos = function(videos){
      videos.forEach(function(video) {
        var location = video.recordingDetails.location;
        var latlng = new google.maps.LatLng(location.latitude, location.longitude);

        $scope.videos.push(video);

        $scope.markers.push({
          'id': video.id,
          'title': video.snippet.title,
          'position': [location.latitude, location.longitude]
        });

        $scope.bounds.extend(latlng);
      })

      // fit bounds
      $scope.map.fitBounds($scope.bounds);
    }

    $scope.bounceMarker = function(id) {
      $scope.map.markers[id].setAnimation(google.maps.Animation.BOUNCE);
    }

    $scope.unbounceMarker = function(id) {
      $scope.map.markers[id].setAnimation(null);
    }

    // TODO: como reseteo el scope?!
    $scope.reset = function() {
      $scope.videos = [];
      $scope.markers = [];
      $scope.params.next = undefined;
      $scope.bounds = new google.maps.LatLngBounds();
    }
  })
  </script>

</body>
</html>